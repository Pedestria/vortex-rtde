const fs=require("fs-extra"),Babel=require("@babel/parser"),traverse_1=require("@babel/traverse"),path=require("path"),resolve=require("resolve"),chalk=require("chalk");function createStarPackage(e,r){let o=StarGraph(r);console.log(o),fs.writeJson("./dep-graph.json",o,e=>{if(e)return console.error(e);console.log("Wrote Star Graph to dep-graph.json ")})}function StarGraph(e){isProduction&&(fs.emptyDirSync("./cache/files"),fs.emptyDirSync("./cache/libs"));let r=new VortexGraph,o=[];GraphDepsAndModsForCurrentFile(addJsExtensionIfNecessary(e),r),o.push(e);for(let e of r.Graph.Star){let n="./";0==o.includes(e.name)&&(1==e.name.includes(n)?(GraphDepsAndModsForCurrentFile(e.name,r),o.push(e.name)):0==isLibrary&&(GraphDepsForLib(e,r),o.push(e.name)))}return r}function GraphDepsAndModsForCurrentFile(e,r){SearchAndGraph(e,r),SearchAndGraph(e,r)}function GraphDepsForLib(e,r){e instanceof ModuleDependency&&GraphDepsAndModsForCurrentFile(resolveLibBundle(e.name),r)}function SearchAndGraph(e,r){const o=fs.readFileSync(e,"utf-8").toString(),n=Babel.parse(o,{sourceType:"module"});traverse_1.default(n,{enter(o){if("ImportDeclaration"===o.node.type){let n=[];for(let e of o.node.specifiers)if("ImportDefaultSpecifier"===e.type){let r=new Module(e.local.name,ModuleTypes.EsDefaultOrNamespaceModule);n.push(r)}else if("ImportSpecifier"===e.type){let r=new Module(e.local.name,ModuleTypes.EsModule);n.push(r)}let t=new MDImportLocation(e,o.node.loc.start.line,n);Transport(new EsModuleDependency(o.node.source.value,t),r,e,t)}}})}function SearchAndGraph(e,r){const o=fs.readFileSync(e,"utf-8").toString();const n=Babel.parse(o,{sourceType:"module"});traverse_1.default(n,{enter(o){if("VariableDeclaration"===o.node.type){let n=[];if(null!==o.node.declarations[0].init&&"CallExpression"===o.node.declarations[0].init.type&&"require"===o.node.declarations[0].init.callee.name){if("ObjectPattern"===o.node.declarations[0].id.type)for(let e of o.node.declarations[0].id.properties)n.push(new Module(e.value.name,ModuleTypes.CjsModule));else n.push(new Module(o.node.declarations[0].id.name,ModuleTypes.CjsDefaultOrNamespaceModule));let t=new MDImportLocation(e,o.node.loc.start.line,n);Transport(new CjsModuleDependency(o.node.declarations[0].init.arguments[0].value,t),r,e,t)}}if("ExpressionStatement"===o.node.type){let n=[];if("AssignmentExpression"===o.node.expression.type&&"MemberExpression"===o.node.expression.left.type&&"CallExpression"===o.node.expression.right.type&&"require"===o.node.expression.right.callee.name){n.push(new Module(o.node.expression.right.arguments[0].value,ModuleTypes.CjsDefaultOrNamespaceModule));let t=new MDImportLocation(e,o.node.loc.start.line,n);Transport(new CjsModuleDependency(o.node.expression.right.arguments[0].value,t),r,e,t)}if("CallExpression"===o.node.expression.type){if("Identifier"===o.node.expression.callee.type&&"require"==o.node.expression.callee.name){n.push(new Module("_Default_",ModuleTypes.CjsDefaultOrNamespaceModule));let t=new MDImportLocation(e,o.node.loc.start.line,n);Transport(new CjsModuleDependency(o.node.expression.arguments[0].value,t),r,e,t)}if("CallExpression"===o.node.expression.callee.type&&"require"===o.node.expression.callee.callee.name){n.push(new Module("_DefaultFunction_",ModuleTypes.CjsDefaultFunction));let t=new MDImportLocation(e,o.node.loc.start.line,n);Transport(new CjsModuleDependency(o.node.expression.callee.arguments[0].value,t),r,e,t)}}}}})}function LocalizedResolve(e,r){if(e==r)return e;if("./"==path.dirname(r))return r;let o=path.dirname(e),n=r;return"./"+path.join(o,n)}function resolveLibBundle(e){let r=new RegExp("min"),o=ResolveLibrary(e);if(o instanceof Array)for(let e of o){if(e.match(r)&&isProduction)return e;if(null==e.match(r)&&0==isProduction)return e}return o}function ResolveLibrary(e){let r=fixLibraryPath(resolve.sync(e)),o=[];if(null!==DefaultQuarkTable.findEntryByName(e))return DefaultQuarkTable.QuarkLibs[DefaultQuarkTable.findEntryByName(e)].bundleLocs;if(0==LibraryRelayVerify(r).length)return r;for(let e of LibraryRelayVerify(r))o.push(LocalizedResolve(r,e));return o}function LibraryRelayVerify(e){const r=fs.readFileSync(e,"utf-8").toString();new RegExp("./");const o=Babel.parse(r,{sourceType:"module"});let n=[];return traverse_1.default(o,{enter(e){"ExpressionStatement"===e.node.type&&"AssignmentExpression"===e.node.expression.type&&"MemberExpression"===e.node.expression.left.type&&"CallExpression"===e.node.expression.right.type&&"module"===e.node.expression.left.object.name&&"exports"===e.node.expression.left.property.name&&"require"===e.node.expression.right.callee.name&&n.push(e.node.expression.right.arguments[0].value)}}),n}function fixLibraryPath(e){if(-1==e.search("node_modules"))throw new Error("Package Does not Exist!");{let r=e.search("node_modules");return"./"+e.slice(r)}}function isQuarky(e){const r=fs.readFileSync(e,"utf-8").toString();new RegExp("./");const o=Babel.parse(r,{sourceType:"module"});return traverse_1.default(o,{enter(r){if("VariableDeclaration"===r.node.type&&null!==r.node.declarations[0].init&&"CallExpression"===r.node.declarations[0].init.type&&"require"===r.node.declarations[0].init.callee.name)if("ObjectPattern"===r.node.declarations[0].id.type){for(let o of r.node.declarations[0].id.properties)if(testForLocalFileRequires(LocalizedResolve(e,o.value)))return!0}else if(testForLocalFileRequires(LocalizedResolve(e,r.node.declarations[0].init.arguments[0].value)))return!0;if("ExpressionStatement"===r.node.type){if("AssignmentExpression"===r.node.expression.type&&"MemberExpression"===r.node.expression.left.type&&"CallExpression"===r.node.expression.right.type&&"require"===r.node.expression.right.callee.name&&testForLocalFileRequires(LocalizedResolve(e,r.node.expression.right.arguments[0].value)))return!0;if("CallExpression"===r.node.expression.type&&"CallExpression"===r.node.expression.callee.type&&"require"===r.node.expression.callee.callee.name&&testForLocalFileRequires(LocalizedResolve(e,r.node.expression.callee.arguments[0].value)))return!0}}}),!1}function testForLocalFileRequires(e){console.log(e);const r=fs.readFileSync(addJsExtensionIfNecessary(e),"utf-8").toString();let o=new RegExp("./");const n=Babel.parse(r,{sourceType:"module"});return traverse_1.default(n,{enter(e){if("VariableDeclaration"===e.node.type){if("CallExpression"===e.node.declarations[0].init.type&&"require"===e.node.declarations[0].init.callee.name)if("ObjectPattern"===e.node.declarations[0].id.type){for(let r of e.node.declarations[0].id.properties)if(null!==r.value.match(o))return!0}else if(null!==e.node.declarations[0].init.arguments[0].value.match(o))return!0}if("ExpressionStatement"===e.node.type){if("AssignmentExpression"===e.node.expression.type&&"MemberExpression"===e.node.expression.left.type&&"CallExpression"===e.node.expression.right.type&&"require"===e.node.expression.right.callee.name&&null!==e.node.expression.right.arguments[0].value.match(o))return!0;if("CallExpression"===e.node.expression.type&&"CallExpression"===e.node.expression.callee.type&&"require"===e.node.expression.callee.callee.name&&null!==e.node.expression.callee.arguments[0].value.match(o))return!0}}}),!1}function addJsExtensionIfNecessary(e){let r=new RegExp(".js");return null!==e.match(r)?e:e+".js"}Object.defineProperty(exports,"__esModule",{value:!0}),Object.defineProperty(exports,"__esModule",{value:!0}),Object.defineProperty(exports,"__esModule",{value:!0}),Object.defineProperty(exports,"__esModule",{value:!0}),Object.defineProperty(exports,"__esModule",{value:!0}),Object.defineProperty(exports,"__esModule",{value:!0});class EsModuleDependency extends ModuleDependency{constructor(e,r){super(e,r)}verifyImportedModules(e,r){const o=fs.readFileSync(e,"utf-8").toString(),n=Babel.parse(o,{sourceType:"module"}).program.body;let t=[];for(let e of n){if("ExportDefaultDeclaration"===e.type){let r=e.declaration.id.name;t.push(new Module(r,ModuleTypes.EsDefaultOrNamespaceModule))}if("ExportNamedDeclaration"==e.type){for(let r of e.specifiers)if("ExportSpecifier"===r.type){let e=r.exported.name;t.push(new Module(e,ModuleTypes.EsModule))}let r=e.declaration.id.name;t.push(new Module(r,ModuleTypes.EsModule))}}let s=new MDImportLocation("buffer",0,t),a=new Error(chalk.bgRed("Non Existant Modules Imported from "+e));for(let e of r.modules)if(0==s.testForModule(e))throw a}}Object.defineProperty(exports,"__esModule",{value:!0});class CjsModuleDependency extends ModuleDependency{constructor(e,r){super(e,r)}verifyImportedModules(e,r){const o=fs.readFileSync(e,"utf-8").toString(),n=Babel.parse(o,{sourceType:"module"}).program.body;let t=[];for(let e of n)"ExpressionStatement"===e.type&&"AssignmentExpression"===e.expression.type&&"MemberExpression"===e.expression.left.type&&"module"===e.expression.left.object.name&&"exports"===e.expression.left.property.name&&("FunctionExpression"===e.expression.right.type||"ArrowFunctionExpression"===e.expression.right.type?t.push(new Module("_DefaultFunction_",ModuleTypes.CjsDefaultFunction)):t.push(new Module(e.expression.right.name,ModuleTypes.CjsModule)));let s=new MDImportLocation("buffer",0,t),a=new Error(chalk.bgRed("Non Existant Modules Imported from "+e));for(let e of r.modules)if(0==s.testForModule(e))throw a}}Object.defineProperty(exports,"__esModule",{value:!0});class VortexGraph{constructor(){this.Graph={Star:Array()}}add(e){this.Graph.Star.push(e)}searchFor(e){for(let r of this.Graph.Star)if(e.name==r.name)return!0;return!1}update(e){for(let r of this.Graph.Star)e instanceof ModuleDependency&&r instanceof ModuleDependency&&ModuleDependencyUpdater(e,r)}remove(e){let r=this.Graph.Star.indexOf(e);this.Graph.Star.splice(r)}display(){return this.Graph.Star}}function ModuleDependencyUpdater(e,r){if(r.name==e.name)for(let o of e.importLocations)0==r.testForImportLocation(o.name)&&r.importLocations.push(o)}function Transport(e,r,o,n){e.name.includes("./")?(e.updateName(LocalizedResolve(o,addJsExtensionIfNecessary(e.name))),(e instanceof EsModuleDependency||e instanceof CjsModuleDependency)&&e.verifyImportedModules(e.name,n)):e instanceof ModuleDependency&&(e.libLoc=resolveLibBundle(e.name)),r.searchFor(e)?r.update(e):r.add(e)}Object.defineProperty(exports,"__esModule",{value:!0}),Object.defineProperty(exports,"__esModule",{value:!0});class ModuleDependency extends Dependency{constructor(e,r){super(e,r)}}Object.defineProperty(exports,"__esModule",{value:!0}),Object.defineProperty(exports,"__esModule",{value:!0});class Module{constructor(e,r){this.name=e,this.type=r}}var ModuleTypes;!function(e){e[e.EsModule=0]="EsModule",e[e.EsDefaultOrNamespaceModule=1]="EsDefaultOrNamespaceModule",e[e.CjsModule=2]="CjsModule",e[e.CjsDefaultOrNamespaceModule=3]="CjsDefaultOrNamespaceModule",e[e.CjsDefaultFunction=4]="CjsDefaultFunction"}(ModuleTypes=exports.ModuleTypes||(exports.ModuleTypes={})),Object.defineProperty(exports,"__esModule",{value:!0});class MDImportLocation extends ImportLocation{constructor(e,r,o){super(e,r),this.modules=o}testForModule(e){for(let r of this.modules)if(r.name==e.name)return!0;return!1}}Object.defineProperty(exports,"__esModule",{value:!0});class QuarkLibTable{constructor(){this.QuarkLibs=[]}addEntry(e){this.QuarkLibs.push(e)}findEntryByName(e){for(let r of this.QuarkLibs)if(r.name==e)return this.QuarkLibs.indexOf(r);return null}}class QuarkLibEntry{constructor(e,r){this.name=e,this.bundleLocs=r}}exports.DefaultQuarkTable.addEntry(new QuarkLibEntry("aws-sdk",["./node_modules/aws-sdk/dist/aws-sdk.js","./node_modules/aws-sdk/dist/aws-sdk.min.js"])),Object.defineProperty(exports,"__esModule",{value:!0});class Dependency{constructor(e,r){this.name=e,this.importLocations=[],this.importLocations.push(r)}testForImportLocation(e){for(let r of this.importLocations)if(r.name==e)return!0;return!1}indexOfImportLocation(e){for(let r of this.importLocations)if(r.name==e)return this.importLocations.indexOf(r)}updateName(e){this.name=e}isLibraryDependency(){return!this.name.includes("./")}}Object.defineProperty(exports,"__esModule",{value:!0});class ImportLocation{constructor(e,r){this.name=e,this.line=r}}